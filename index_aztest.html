<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="QRAM Decoder">
  <meta name="theme-color" content="#1a1a2e">
  <title>QRAM Decoder</title>
  <link rel="manifest" href="manifest.json">

  <script src="./libs/qram.min.js"></script>

  <!-- ZXing (Aztec/QR/DM/PDF417 capable) -->
  <script src="./zxing-browser.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e; color: #eee; min-height: 100vh; padding: 15px;
    }
    .container { max-width: 520px; margin: 0 auto; }
    h1 { text-align: center; margin-bottom: 12px; font-size: 1.35rem; color: #00d4ff; }

    .row { display:flex; gap:10px; align-items:center; margin-bottom: 10px; flex-wrap:wrap; }
    select, button {
      border-radius: 10px; border: 1px solid #333;
      background: #16213e; color: #eee; padding: 10px 12px;
      font-size: 0.95rem; font-weight: 600;
    }
    button { cursor:pointer; border:none; }
    .btn-success { background:#00ff88; color:#000; }
    .btn-secondary { background:#16213e; color:#eee; border: 1px solid #333; }
    #video-container {
      position: relative; width: 100%;
      background: #000; border-radius: 12px; overflow: hidden; margin: 10px 0 12px 0;
      aspect-ratio: 1;
    }
    #video {
      width:100%; height:100%;
      object-fit: contain; background:#000;
    }
    #overlay {
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      pointer-events:none;
    }
    #scan-region {
      width: 90%; height: 90%;
      border: 3px solid #00d4ff; border-radius: 12px;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
    }

    #error-msg {
      background:#ff4444; color:#fff; padding:10px 15px; border-radius:8px;
      margin-bottom:10px; display:none; font-size:0.9rem;
    }
    #error-msg.show { display:block; }

    .status-box { background:#16213e; border-radius: 12px; padding: 12px; margin-bottom: 10px; }
    .status-label { font-size: 0.8rem; color:#888; margin-bottom: 4px; }
    .status-value { font-size: 1.05rem; font-weight: 700; }

    #progress-bar { width:100%; height:10px; background:#16213e; border-radius:5px; overflow:hidden; margin-bottom:10px; }
    #progress-fill { height:100%; width:0%; background: linear-gradient(90deg,#00d4ff,#00ff88); transition: width .2s ease; }

    .stats-row { display:flex; gap:10px; margin-bottom:10px; }
    .stat-box { flex:1; background:#16213e; border-radius:10px; padding:10px; text-align:center; }
    .stat-value { font-size:1.2rem; font-weight:800; color:#00d4ff; }
    .stat-label { font-size:.7rem; color:#888; margin-top:3px; }

    #result-container { display:none; background:#16213e; border-radius:12px; padding:12px; margin-bottom:10px; }
    #result-container.show { display:block; }
    #result { width:100%; height:180px; background:#0d1117; border:1px solid #333; border-radius:8px;
      color:#00ff88; font-family: ui-monospace, Menlo, Monaco, Consolas, monospace; font-size:11px;
      padding:10px; resize: vertical;
    }

    .scan-indicator {
      position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
      background: rgba(0,255,136,0.9); color:#000; padding:5px 12px; border-radius:20px;
      font-size:.75rem; font-weight:700; opacity:0; transition: opacity .1s;
    }
    .scan-indicator.flash { opacity:1; }
  </style>
</head>
<body>
  <div class="container">
    <h1>QRAM Decoder</h1>

    <div id="error-msg"></div>

    <div class="row">
      <label style="display:flex; gap:8px; align-items:center;">
        <span style="color:#bbb;font-weight:700;">Barcode</span>
        <select id="format-select" title="Select which barcode format to decode">
          <option value="AUTO" selected>Auto (All)</option>
          <option value="AZTEC">Aztec</option>
          <option value="DATA_MATRIX">Data Matrix</option>
          <option value="QR_CODE">QR Code</option>
          <option value="PDF_417">PDF417</option>
        </select>
      </label>

      <label style="display:flex; gap:8px; align-items:center;">
        <span style="color:#bbb;font-weight:700;">Scan</span>
        <select id="scan-interval">
          <option value="250">250ms</option>
          <option value="120">120ms</option>
          <option value="80" selected>80ms</option>
          <option value="50">50ms</option>
        </select>
      </label>
    </div>

    <div class="row">
      <button id="camera-btn" class="btn-secondary">Use Camera</button>
      <button id="video-file-btn" class="btn-secondary">Use MP4 Video File</button>
      <input id="video-file-input" type="file" accept="video/*" style="display:none" />
      <button id="reset-btn" class="btn-secondary">Reset</button>
    </div>

    <div id="video-container">
      <video id="video" autoplay playsinline muted></video>
      <div id="overlay"><div id="scan-region"></div></div>
      <div id="scan-indicator" class="scan-indicator">Packet</div>
    </div>

    <div id="progress-bar"><div id="progress-fill"></div></div>

    <div class="stats-row">
      <div class="stat-box">
        <div class="stat-value" id="blocks-received">0</div>
        <div class="stat-label">Blocks</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="blocks-total">?</div>
        <div class="stat-label">Total</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="packets-scanned">0</div>
        <div class="stat-label">Packets</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="speed-display">--</div>
        <div class="stat-label">Speed</div>
      </div>
    </div>

    <div class="status-box">
      <div class="status-label">Status</div>
      <div class="status-value" id="status">Ready. Choose Camera or Video File.</div>
    </div>

    <div id="result-container">
      <div class="status-label" id="result-label">Decoded Content</div>
      <textarea id="result" readonly></textarea>
      <button id="copy-btn" class="btn-success" style="margin-top:10px; width:100%;">Copy to Clipboard</button>
      <button id="save-btn" class="btn-success" style="margin-top:10px; width:100%;">Save as File</button>
    </div>
  </div>

<script>
(() => {
  // Elements
  const video = document.getElementById('video');
  const statusEl = document.getElementById('status');
  const progressFill = document.getElementById('progress-fill');
  const blocksReceivedEl = document.getElementById('blocks-received');
  const blocksTotalEl = document.getElementById('blocks-total');
  const packetsScannedEl = document.getElementById('packets-scanned');
  const speedDisplayEl = document.getElementById('speed-display');
  const resultContainer = document.getElementById('result-container');
  const resultLabel = document.getElementById('result-label');
  const resultEl = document.getElementById('result');
  const copyBtn = document.getElementById('copy-btn');
  const saveBtn = document.getElementById('save-btn');
  const errorMsg = document.getElementById('error-msg');
  const scanIndicator = document.getElementById('scan-indicator');

  const cameraBtn = document.getElementById('camera-btn');
  const videoFileBtn = document.getElementById('video-file-btn');
  const videoFileInput = document.getElementById('video-file-input');
  const resetBtn = document.getElementById('reset-btn');

  const formatSelect = document.getElementById('format-select');
  const scanIntervalSelect = document.getElementById('scan-interval');

  // State
  let scanning = false;
  let decoder = null;
  let packetsScanned = 0;
  let firstPacketTime = null;
  let speedInterval = null;
  let pendingProgressUpdate = false;
  let lastReceivedBlocks = 0;
  let lastTotalBlocks = 0;
  let lastPacketSignature = null; // raw text dedupe

  let zxingControls = null;
  let zxingReader = null;
  let cameraStream = null;

  // --- Helpers ---
  function showError(msg) {
    errorMsg.textContent = msg;
    errorMsg.classList.add('show');
  }
  function hideError() { errorMsg.classList.remove('show'); }

  function flashIndicator() {
    scanIndicator.classList.add('flash');
    setTimeout(() => scanIndicator.classList.remove('flash'), 150);
  }

  function formatBytes(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }
  function formatSpeed(bytesPerSec) {
    if (bytesPerSec < 1024) return bytesPerSec.toFixed(0) + ' B/s';
    return (bytesPerSec / 1024).toFixed(1) + ' KB/s';
  }

  function base64UrlToBytes(s) {
    const t = (s || '').trim().replace(/-/g, '+').replace(/_/g, '/');
    const padded = t + '==='.slice((t.length + 3) % 4);
    const bin = atob(padded);
    const out = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) out[i] = bin.charCodeAt(i) & 0xff;
    return out;
  }

  function scheduleProgressUpdate() {
    if (pendingProgressUpdate) return;
    pendingProgressUpdate = true;
    requestAnimationFrame(() => {
      pendingProgressUpdate = false;
      packetsScannedEl.textContent = packetsScanned;
      blocksReceivedEl.textContent = lastReceivedBlocks;
      blocksTotalEl.textContent = lastTotalBlocks;
      const pct = lastTotalBlocks > 0 ? Math.min(100, (lastReceivedBlocks / lastTotalBlocks) * 100) : 0;
      progressFill.style.width = `${pct}%`;
      statusEl.textContent = `Receiving: ${lastReceivedBlocks}/${lastTotalBlocks} blocks`;
    });
  }

  function startSpeedTracking() {
    if (speedInterval) return;
    speedInterval = setInterval(() => {
      if (!firstPacketTime || lastTotalBlocks === 0) return;
      const elapsed = (Date.now() - firstPacketTime) / 1000;
      if (elapsed < 0.5) return;
      const pps = packetsScanned / elapsed;
      speedDisplayEl.textContent = pps.toFixed(1) + '/s';
    }, 500);
  }
  function stopSpeedTracking() {
    if (speedInterval) { clearInterval(speedInterval); speedInterval = null; }
  }

  function stopZXing() {
    try { if (zxingControls && typeof zxingControls.stop === 'function') zxingControls.stop(); } catch (e) {}
    zxingControls = null;
    try { if (zxingReader && typeof zxingReader.reset === 'function') zxingReader.reset(); } catch (e) {}
    zxingReader = null;
  }

  function stopCamera() {
    if (cameraStream) {
      cameraStream.getTracks().forEach(t => t.stop());
      cameraStream = null;
    }
  }

  function stopAllInputs() {
    stopZXing();
    stopCamera();
    try { if (video.src && video.src.startsWith('blob:')) URL.revokeObjectURL(video.src); } catch (e) {}
    video.srcObject = null;
  }

  function resetUI() {
    packetsScanned = 0;
    firstPacketTime = null;
    pendingProgressUpdate = false;
    lastReceivedBlocks = 0;
    lastTotalBlocks = 0;
    lastPacketSignature = null;

    resultContainer.classList.remove('show');
    resultEl.value = '';
    progressFill.style.width = '0%';
    blocksReceivedEl.textContent = '0';
    blocksTotalEl.textContent = '?';
    packetsScannedEl.textContent = '0';
    speedDisplayEl.textContent = '--';
    hideError();
    statusEl.textContent = 'Ready. Choose Camera or Video File.';
  }

  function initQRAMDecoder() {
    decoder = new qram.Decoder();
    decoder.decode().then(onComplete).catch(err => {
      if (err.name !== 'AbortError') showError('Decode error: ' + err.message);
    });
  }

  function buildZXingReader() {
    if (!window.ZXingBrowser) throw new Error('ZXingBrowser not found (check include).');

    const hints = new Map();
    if (ZXingBrowser.DecodeHintType && ZXingBrowser.BarcodeFormat) {
      const fmt = formatSelect.value;
      const map = {
        AZTEC: ZXingBrowser.BarcodeFormat.AZTEC,
        DATA_MATRIX: ZXingBrowser.BarcodeFormat.DATA_MATRIX,
        QR_CODE: ZXingBrowser.BarcodeFormat.QR_CODE,
        PDF_417: ZXingBrowser.BarcodeFormat.PDF_417,
      };
      if (fmt !== 'AUTO') {
        hints.set(ZXingBrowser.DecodeHintType.POSSIBLE_FORMATS, [map[fmt]]);
      }
      hints.set(ZXingBrowser.DecodeHintType.TRY_HARDER, true);
    }

    const interval = parseInt(scanIntervalSelect.value, 10) || 80;
    zxingReader = new ZXingBrowser.BrowserMultiFormatReader(hints, interval);
  }

  async function onZXingResult(result) {
    if (!scanning || !result) return;

    try {
      const rawText = result.getText();
      if (!rawText) return;

      // Dedupe by raw barcode text (best for Base64URL packets)
      if (rawText === lastPacketSignature) return;
      lastPacketSignature = rawText;

      const packetData = base64UrlToBytes(rawText);

      const progress = await decoder.enqueue(packetData);
      packetsScanned++;
      flashIndicator();

      if (!firstPacketTime) {
        firstPacketTime = Date.now();
        startSpeedTracking();
        hideError();
      }

      if (progress) {
        lastReceivedBlocks = progress.receivedBlocks;
        lastTotalBlocks = progress.totalBlocks;
        scheduleProgressUpdate();
      }
    } catch (e) {
      // ignore invalid packets
    }
  }

  // --- Start camera mode ---
  async function startCameraMode() {
    try {
      stopAllInputs();
      stopSpeedTracking();
      decoder?.cancel?.();

      resetUI();
      scanning = true;
      initQRAMDecoder();
      buildZXingReader();

      statusEl.textContent = 'Starting camera...';

      cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = cameraStream;
      video.playsInline = true;
      video.muted = true;

      await new Promise((resolve, reject) => {
        if (video.readyState >= 1) resolve();
        else {
          video.addEventListener('loadedmetadata', resolve, { once: true });
          video.addEventListener('error', reject, { once: true });
        }
      });

      await video.play();
      statusEl.textContent = 'Point camera at animated barcode...';

      zxingControls = await zxingReader.decodeFromVideoDevice(
        null,
        video,
        (result, err, controls) => { if (result) onZXingResult(result); }
      );
    } catch (err) {
      scanning = false;
      decoder?.cancel?.();
      showError('Camera init failed: ' + (err?.message || err));
    }
  }

  // --- Start video-file mode ---
  async function startVideoFileMode(file) {
    try {
      stopAllInputs();
      stopSpeedTracking();
      decoder?.cancel?.();

      resetUI();
      scanning = true;
      initQRAMDecoder();
      buildZXingReader();

      statusEl.textContent = 'Loading video file...';

      const url = URL.createObjectURL(file);
      video.srcObject = null;
      video.src = url;
      video.loop = true;
      video.muted = true;
      video.playsInline = true;

      await new Promise((resolve, reject) => {
        video.onloadedmetadata = resolve;
        video.onerror = reject;
      });

      await video.play();
      const vc = document.getElementById('video-container');
      if (video.videoWidth && video.videoHeight) vc.style.aspectRatio = `${video.videoWidth} / ${video.videoHeight}`;

      statusEl.textContent = 'Scanning video...';

      zxingControls = await zxingReader.decodeFromVideoElement(
        video,
        (result, err, controls) => { if (result) onZXingResult(result); }
      );
    } catch (err) {
      scanning = false;
      decoder?.cancel?.();
      showError('Video scan init failed: ' + (err?.message || err));
    }
  }

  // --- Completion ---
  function onComplete(result) {
    scanning = false;
    stopSpeedTracking();

    const data = result.data;
    if (firstPacketTime) {
      const elapsed = (Date.now() - firstPacketTime) / 1000;
      if (elapsed > 0) speedDisplayEl.textContent = formatSpeed(data.length / elapsed);
    }

    const text = new TextDecoder().decode(data);
    resultLabel.textContent = 'Decoded Content';
    resultEl.value = text;
    resultContainer.classList.add('show');

    statusEl.textContent = `Complete! ${formatBytes(data.length)} received.`;
    progressFill.style.width = '100%';

    stopAllInputs();
  }

  // Buttons
  cameraBtn.addEventListener('click', () => startCameraMode());
  videoFileBtn.addEventListener('click', () => videoFileInput.click());
  videoFileInput.addEventListener('change', async () => {
    const file = videoFileInput.files && videoFileInput.files[0];
    if (!file) return;
    await startVideoFileMode(file);
    videoFileInput.value = '';
  });

  resetBtn.addEventListener('click', () => {
    scanning = false;
    stopSpeedTracking();
    decoder?.cancel?.();
    stopAllInputs();
    resetUI();
  });

  formatSelect.addEventListener('change', () => {
    // switching formats mid-scan is confusing; easiest is to reset
    if (scanning) {
      scanning = false;
      decoder?.cancel?.();
      stopAllInputs();
      resetUI();
    }
  });

  copyBtn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(resultEl.value);
      copyBtn.textContent = 'Copied!';
      setTimeout(() => copyBtn.textContent = 'Copy to Clipboard', 2000);
    } catch (e) {}
  });

  saveBtn.addEventListener('click', () => {
    const blob = new Blob([resultEl.value], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'qram-transfer.txt';
    a.click();
    URL.revokeObjectURL(url);
  });

  // SW
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  }

  // Init
  resetUI();
})();
</script>
</body>
</html>