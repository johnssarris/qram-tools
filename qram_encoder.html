<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>QRAM TX</title>
<script src="https://unpkg.com/qram@0.3.9/dist/qram.min.js"></script>
<script src="https://unpkg.com/qrcode@1.5.1/build/qrcode.min.js"></script>
<style>
body{font-family:system-ui;background:#1a1a2e;color:#eee;padding:20px;max-width:800px;margin:auto}
textarea{width:100%;height:200px;background:#0d1117;color:#0f0;border:1px solid #333;padding:10px;font-family:monospace;font-size:12px}
button{padding:12px 24px;margin:10px 5px 10px 0;border:none;border-radius:6px;font-size:16px;cursor:pointer}
#start{background:#0f0;color:#000}
#stop{background:#f44;color:#fff}
canvas{display:block;margin:20px auto;background:#fff;border-radius:8px}
#stats{text-align:center;font-size:14px;color:#888}
.row{display:flex;gap:15px;align-items:center;margin:10px 0}
.row label{color:#aaa}
.row input{width:60px;padding:5px;background:#0d1117;border:1px solid #333;color:#eee}
</style>
</head>
<body>
<h2>QRAM Encoder</h2>
<textarea id="txt" placeholder="Paste code here..."></textarea>
<div class="row">
<button id="start">▶ Start</button>
<button id="stop">■ Stop</button>
<label>FPS:<input type="number" id="fps" value="6"></label>
<label>Block:<input type="number" id="blk" value="300"></label>
</div>
<canvas id="qr" width="350" height="350"></canvas>
<div id="stats"></div>

<script>
var running=false, cancel=false;

function b64encode(u8){
  var s='',c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_';
  for(var i=0;i<u8.length;i+=3){
    var b=(u8[i]<<16)|(u8[i+1]<<8)|u8[i+2];
    s+=c[b>>18&63]+c[b>>12&63]+c[b>>6&63]+c[b&63];
  }
  var pad=u8.length%3;
  if(pad)s=s.slice(0,pad-3);
  return s;
}

async function start(){
  if(running)return;
  var txt=document.getElementById('txt').value;
  if(!txt){alert('Enter text');return;}
  
  var fps=parseInt(document.getElementById('fps').value)||6;
  var blockSize=parseInt(document.getElementById('blk').value)||300;
  var delay=1000/fps;
  
  var data=new TextEncoder().encode(txt);
  var enc=new qram.Encoder({data:data,blockSize:blockSize});
  var stream=await enc.createReadableStream();
  var reader=stream.getReader();
  
  running=true;cancel=false;
  var n=0,blocks=Math.ceil(data.length/blockSize);
  document.getElementById('stats').textContent=data.length+' bytes, '+blocks+' blocks';
  
  while(!cancel){
    var r=await reader.read();
    if(r.done)break;
    var pkt=r.value;
    var b64=b64encode(pkt.data);
    await QRCode.toCanvas(document.getElementById('qr'),b64,{width:350,margin:1,errorCorrectionLevel:'L'});
    n++;
    document.getElementById('stats').textContent=data.length+' bytes, '+blocks+' blocks, packet #'+n;
    await new Promise(function(ok){setTimeout(ok,delay);});
  }
  running=false;
}

function stop(){cancel=true;running=false;}

document.getElementById('start').onclick=start;
document.getElementById('stop').onclick=stop;
</script>
</body>
</html>
