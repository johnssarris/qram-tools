<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QRAM Encoder</title>
  <script src="https://unpkg.com/qram@0.3.9/dist/qram.min.js"></script>
  <script src="https://unpkg.com/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/base64url-universal@1.1.0/dist/base64url-universal.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #eee;
      min-height: 100vh;
      padding: 30px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 2rem;
      color: #00d4ff;
    }
    
    .subtitle {
      text-align: center;
      color: #888;
      margin-bottom: 30px;
    }
    
    .input-section {
      background: #16213e;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .input-section label {
      display: block;
      margin-bottom: 10px;
      color: #00d4ff;
      font-weight: 600;
    }
    
    textarea {
      width: 100%;
      height: 200px;
      background: #0d1117;
      border: 1px solid #333;
      border-radius: 8px;
      color: #00ff88;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 13px;
      padding: 15px;
      resize: vertical;
    }
    
    textarea:focus {
      outline: none;
      border-color: #00d4ff;
    }
    
    .controls {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .control-group label {
      margin: 0;
      font-size: 0.9rem;
      color: #aaa;
    }
    
    input[type="number"] {
      width: 70px;
      padding: 8px;
      background: #0d1117;
      border: 1px solid #333;
      border-radius: 6px;
      color: #eee;
      font-size: 0.9rem;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, opacity 0.2s;
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #00d4ff, #00ff88);
      color: #000;
    }
    
    .btn-danger {
      background: #ff4444;
      color: #fff;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .qr-section {
      display: none;
      background: #16213e;
      border-radius: 12px;
      padding: 30px;
      text-align: center;
    }
    
    .qr-section.show {
      display: block;
    }
    
    #qr-canvas {
      background: #fff;
      border-radius: 8px;
      margin: 0 auto 20px;
      display: block;
    }
    
    .stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .stat {
      text-align: center;
    }
    
    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #00d4ff;
    }
    
    .stat-label {
      font-size: 0.8rem;
      color: #888;
    }
    
    .instructions {
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      font-size: 0.9rem;
      line-height: 1.6;
    }
    
    .instructions strong {
      color: #00d4ff;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üì§ QRAM Encoder</h1>
    <p class="subtitle">Transfer code via animated QR codes with fountain codes</p>
    
    <div class="input-section">
      <label for="code-input">Paste your code here:</label>
      <textarea id="code-input" placeholder="// Paste your Python, JavaScript, or any text here..."></textarea>
      
      <div class="controls">
        <button id="start-btn" class="btn btn-primary">‚ñ∂Ô∏è Start Streaming</button>
        <button id="stop-btn" class="btn btn-danger" style="display: none;">‚èπÔ∏è Stop</button>
        
        <div class="control-group">
          <label for="fps">FPS:</label>
          <input type="number" id="fps" value="8" min="1" max="30">
        </div>
        
        <div class="control-group">
          <label for="block-size">Block Size:</label>
          <input type="number" id="block-size" value="400" min="100" max="1500" step="50">
        </div>
      </div>
    </div>
    
    <div id="qr-section" class="qr-section">
      <canvas id="qr-canvas"></canvas>
      
      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="data-size">0</div>
          <div class="stat-label">Bytes</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="block-count">0</div>
          <div class="stat-label">Blocks</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="packet-count">0</div>
          <div class="stat-label">Packets Sent</div>
        </div>
      </div>
      
      <div class="instructions">
        <strong>Instructions:</strong> Point your phone camera at this QR code. 
        The animated sequence uses fountain codes ‚Äî you don't need to catch every frame.
        Just keep watching until your decoder reports completion.
      </div>
    </div>
  </div>

  <script>
    const codeInput = document.getElementById('code-input');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const fpsInput = document.getElementById('fps');
    const blockSizeInput = document.getElementById('block-size');
    const qrSection = document.getElementById('qr-section');
    const qrCanvas = document.getElementById('qr-canvas');
    const dataSizeEl = document.getElementById('data-size');
    const blockCountEl = document.getElementById('block-count');
    const packetCountEl = document.getElementById('packet-count');
    
    let streaming = false;
    let stream = null;
    let packetCount = 0;
    
    startBtn.addEventListener('click', startStreaming);
    stopBtn.addEventListener('click', stopStreaming);
    
    async function startStreaming() {
      const text = codeInput.value;
      if (!text.trim()) {
        alert('Please enter some code to transfer');
        return;
      }
      
      const fps = parseInt(fpsInput.value) || 8;
      const blockSize = parseInt(blockSizeInput.value) || 400;
      
      // Convert text to Uint8Array
      const encoder = new TextEncoder();
      const data = encoder.encode(text);
      
      // Update UI
      dataSizeEl.textContent = data.length;
      blockCountEl.textContent = Math.ceil(data.length / blockSize);
      packetCount = 0;
      packetCountEl.textContent = '0';
      
      // Create qram encoder
      const qramEncoder = new qram.Encoder({data, blockSize});
      const timer = qramEncoder.createTimer({fps});
      stream = await qramEncoder.createReadableStream();
      const reader = stream.getReader();
      
      streaming = true;
      qrSection.classList.add('show');
      startBtn.style.display = 'none';
      stopBtn.style.display = 'inline-block';
      
      timer.start();
      
      while (streaming) {
        try {
          const {value: packet, done} = await reader.read();
          if (done || !streaming) break;
          
          // Encode packet data as base64url and display as QR
          const encoded = base64url.encode(packet.data);
          
          await QRCode.toCanvas(qrCanvas, encoded, {
            width: 400,
            margin: 2,
            errorCorrectionLevel: 'L'
          });
          
          packetCount++;
          packetCountEl.textContent = packetCount;
          
          await timer.nextFrame();
        } catch (err) {
          if (streaming) {
            console.error('Streaming error:', err);
          }
          break;
        }
      }
    }
    
    function stopStreaming() {
      streaming = false;
      if (stream) {
        stream.cancel();
        stream = null;
      }
      startBtn.style.display = 'inline-block';
      stopBtn.style.display = 'none';
    }
  </script>
</body>
</html>
