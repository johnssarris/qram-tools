<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0f0f1a">
  <title>QRAM</title>
  <link rel="manifest" href="manifest.json">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:      #0f0f1a;
      --surface: #1a1a2e;
      --border:  #2a2a4a;
      --accent:  #00d4ff;
      --green:   #00ff88;
      --red:     #ff4466;
      --text:    #e0e0f0;
      --muted:   #8888aa;
      --radius:  10px;
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 15px;
      line-height: 1.5;
      overscroll-behavior: none;
    }

    /* ── Tabs ── */
    #tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }
    .tab-btn {
      flex: 1;
      padding: 14px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--muted);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: color .15s, border-color .15s;
      -webkit-tap-highlight-color: transparent;
    }
    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    /* ── Panels ── */
    .panel { display: none; padding: 16px; }
    .panel.active { display: block; }

    /* ── Form elements ── */
    label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 4px; }
    input[type=range] { width: 100%; accent-color: var(--accent); }
    select, textarea {
      width: 100%; background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); color: var(--text); padding: 8px 10px;
      font-size: 14px; outline: none;
    }
    select:focus, textarea:focus { border-color: var(--accent); }
    textarea { resize: vertical; font-family: 'Menlo', 'Courier New', monospace; }

    /* ── Buttons ── */
    button {
      cursor: pointer; border: none; border-radius: var(--radius);
      font-size: 14px; font-weight: 600; padding: 10px 18px;
      transition: opacity .15s, transform .1s;
      -webkit-tap-highlight-color: transparent;
    }
    button:active { transform: scale(.97); }
    .btn-primary  { background: var(--accent); color: #000; }
    .btn-success  { background: var(--green);  color: #000; }
    .btn-danger   { background: var(--red);    color: #fff; }
    .btn-ghost    { background: var(--border); color: var(--text); }
    button:disabled { opacity: .4; cursor: default; }

    /* ── Rows ── */
    .row { display: flex; gap: 10px; align-items: center; margin-bottom: 12px; }
    .row label { margin: 0; flex: 1; }

    /* ── Mode tabs (Text / File) inside encoder ── */
    #mode-tabs { display: flex; gap: 8px; margin-bottom: 14px; }
    .mode-btn {
      flex: 1; padding: 8px; background: var(--border); color: var(--muted);
      border-radius: var(--radius); font-size: 13px; font-weight: 600;
    }
    .mode-btn.active { background: var(--accent); color: #000; }

    /* ── File drop zone ── */
    #drop-zone {
      border: 2px dashed var(--border); border-radius: var(--radius);
      padding: 28px; text-align: center; color: var(--muted);
      transition: border-color .2s, background .2s; margin-bottom: 12px;
      cursor: pointer;
    }
    #drop-zone.drag-over { border-color: var(--accent); background: rgba(0,212,255,.06); }
    #drop-zone.has-file  { border-color: var(--green);  color: var(--green); }
    #drop-zone .drop-hint { font-size: 13px; margin-top: 4px; color: var(--muted); }
    #file-input { display: none; }

    /* ── Encoder settings ── */
    .settings-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
      margin-bottom: 14px;
    }
    .settings-grid .field { display: flex; flex-direction: column; gap: 4px; }
    .settings-grid label { font-size: 12px; }
    .settings-grid select { padding: 6px 8px; font-size: 13px; }

    .checkbox-row { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
    .checkbox-row input { width: 16px; height: 16px; accent-color: var(--accent); }
    .checkbox-row label { margin: 0; font-size: 14px; color: var(--text); cursor: pointer; }

    /* ── QR canvas ── */
    #qr-wrap {
      display: none; flex-direction: column; align-items: center;
      gap: 10px; margin: 14px 0;
    }
    #qr-wrap.active { display: flex; }
    #qr-canvas {
      border-radius: var(--radius); background: #fff;
      max-width: 100%; width: 340px; height: 340px;
      image-rendering: pixelated;
    }
    #enc-status { font-size: 13px; color: var(--muted); text-align: center; }
    #enc-controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }

    /* ── Encoder action bar ── */
    #enc-actions { display: flex; gap: 10px; margin-bottom: 14px; flex-wrap: wrap; }

    /* ── Decoder: video ── */
    #video-wrap {
      position: relative; border-radius: var(--radius);
      overflow: hidden; background: #000; aspect-ratio: 1;
      max-width: 100%; margin-bottom: 14px;
    }
    #video {
      width: 100%; height: 100%;
      object-fit: cover; display: block;
    }
    #scan-overlay {
      position: absolute; inset: 7.5%; /* 85% of the frame */
      border: 2px solid rgba(0,212,255,.7);
      border-radius: 8px; pointer-events: none;
      box-shadow: 0 0 0 9999px rgba(0,0,0,.35);
    }

    /* ── Progress ── */
    #progress-wrap { margin-bottom: 14px; }
    #progress-bar-bg {
      height: 6px; background: var(--border);
      border-radius: 3px; overflow: hidden;
    }
    #progress-bar {
      height: 100%; width: 0%; background: var(--accent);
      border-radius: 3px; transition: width .25s ease;
    }
    #progress-bar.done { background: var(--green); }

    /* ── Stats ── */
    #stats {
      display: grid; grid-template-columns: repeat(4, 1fr);
      gap: 8px; margin-bottom: 14px;
    }
    .stat-box {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 8px; text-align: center;
    }
    .stat-val { font-size: 18px; font-weight: 700; color: var(--accent); }
    .stat-lbl { font-size: 11px; color: var(--muted); margin-top: 2px; }

    /* ── Decode status / result ── */
    #dec-status { font-size: 14px; color: var(--muted); margin-bottom: 10px; min-height: 22px; }
    #result-area { display: none; }
    #result-text {
      width: 100%; min-height: 120px; max-height: 260px;
      font-family: 'Menlo', 'Courier New', monospace; font-size: 13px;
    }
    #result-file {
      display: none; background: var(--surface); border: 1px solid var(--green);
      border-radius: var(--radius); padding: 14px; margin-bottom: 10px;
      color: var(--green);
    }
    #result-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    #error-box {
      display: none; background: rgba(255,68,102,.1);
      border: 1px solid var(--red); border-radius: var(--radius);
      padding: 10px 14px; color: var(--red); font-size: 13px;
      margin-top: 10px;
    }

    /* ── Misc ── */
    .field-row { margin-bottom: 12px; }
    .section-header {
      font-size: 11px; text-transform: uppercase; letter-spacing: .06em;
      color: var(--muted); margin-bottom: 8px; margin-top: 14px;
    }
    .val-display { font-size: 13px; color: var(--accent); font-weight: 600; }
  </style>
</head>
<body>

<div id="tabs">
  <button class="tab-btn" id="tab-decode" onclick="switchTab('decode')">Decode</button>
  <button class="tab-btn" id="tab-encode" onclick="switchTab('encode')">Encode</button>
</div>

<!-- ══════════════ DECODE PANEL ══════════════ -->
<div class="panel" id="panel-decode">

  <div id="video-wrap">
    <video id="video" autoplay muted playsinline></video>
    <div id="scan-overlay"></div>
  </div>

  <div id="progress-wrap">
    <div id="progress-bar-bg"><div id="progress-bar"></div></div>
  </div>

  <div id="stats">
    <div class="stat-box"><div class="stat-val" id="s-decoded">—</div><div class="stat-lbl">Decoded</div></div>
    <div class="stat-box"><div class="stat-val" id="s-total">—</div><div class="stat-lbl">Total</div></div>
    <div class="stat-box"><div class="stat-val" id="s-frames">0</div><div class="stat-lbl">Frames</div></div>
    <div class="stat-box"><div class="stat-val" id="s-speed">—</div><div class="stat-lbl">KB/s</div></div>
  </div>

  <div id="dec-status">Waiting for camera…</div>

  <div id="result-area">
    <div id="result-file">
      <strong id="result-filename"></strong>
      <div id="result-filesize" style="font-size:12px;color:var(--muted);margin-top:2px;"></div>
    </div>
    <textarea id="result-text" readonly placeholder="Decoded text will appear here…"></textarea>
    <div id="result-actions">
      <button class="btn-primary"  id="btn-copy"     onclick="app.copyResult()">Copy</button>
      <button class="btn-success"  id="btn-save"     onclick="app.saveResult()">Save</button>
      <button class="btn-ghost"    id="btn-dec-reset" onclick="app.resetDecoder()">Reset</button>
    </div>
  </div>

  <div id="error-box"></div>
</div>

<!-- ══════════════ ENCODE PANEL ══════════════ -->
<div class="panel" id="panel-encode">

  <!-- Input mode selector -->
  <div id="mode-tabs">
    <button class="mode-btn" id="mode-text" onclick="app.setInputMode('text')">Text</button>
    <button class="mode-btn" id="mode-file" onclick="app.setInputMode('file')">File</button>
  </div>

  <!-- Text input -->
  <div id="text-input-area" class="field-row">
    <label for="text-in">Paste text to transmit</label>
    <textarea id="text-in" rows="6" placeholder="Type or paste text here…"></textarea>
  </div>

  <!-- File drop zone -->
  <div id="file-input-area" style="display:none">
    <div id="drop-zone"
         onclick="document.getElementById('file-input').click()"
         ondragover="event.preventDefault();this.classList.add('drag-over')"
         ondragleave="this.classList.remove('drag-over')"
         ondrop="app.handleDrop(event)">
      <div id="drop-label">Tap to choose a file, or drag &amp; drop</div>
      <div class="drop-hint">Max 5 MB</div>
    </div>
    <input type="file" id="file-input" onchange="app.handleFileSelect(event)">
  </div>

  <!-- Settings -->
  <div class="section-header">Settings</div>
  <div class="settings-grid">
    <div class="field">
      <label for="sel-fps">FPS</label>
      <select id="sel-fps">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="5">5</option>
        <option value="8">8</option>
        <option value="10" selected>10</option>
        <option value="15">15</option>
        <option value="20">20</option>
        <option value="30">30</option>
      </select>
    </div>
    <div class="field">
      <label for="sel-ec">Error Correction</label>
      <select id="sel-ec">
        <option value="0" selected>L – Low (7%)</option>
        <option value="1">M – Medium (15%)</option>
        <option value="2">Q – Quartile (25%)</option>
        <option value="3">H – High (30%)</option>
      </select>
    </div>
    <div class="field">
      <label for="sel-block">Block Size</label>
      <select id="sel-block">
        <option value="100">100 B</option>
        <option value="200" selected>200 B</option>
        <option value="300">300 B</option>
        <option value="400">400 B</option>
        <option value="500">500 B</option>
        <option value="600">600 B</option>
        <option value="800">800 B</option>
        <option value="1000">1000 B</option>
      </select>
    </div>
    <div class="field">
      <label>&nbsp;</label>
      <div class="checkbox-row" style="margin:0">
        <input type="checkbox" id="chk-compress" checked>
        <label for="chk-compress" style="font-size:13px">Compress</label>
      </div>
    </div>
  </div>

  <!-- Start / Stop -->
  <div id="enc-actions">
    <button class="btn-primary" id="btn-start" onclick="app.startEncoder()">Start</button>
    <button class="btn-danger"  id="btn-stop"  onclick="app.stopEncoder()" disabled>Stop</button>
  </div>

  <!-- QR display -->
  <div id="qr-wrap">
    <canvas id="qr-canvas" width="340" height="340"></canvas>
    <div id="enc-status"></div>
  </div>

</div>

<!-- ══════════════ Scripts ══════════════ -->
<script src="libs/pako.min.js"></script>
<script src="libs/compress.js"></script>
<script src="libs/jsQR.js"></script>
<script type="module" src="app.js"></script>

<script>
  // Service worker registration.
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  }

  // Tab switching (plain global, not module)
  function switchTab(name) {
    document.getElementById('tab-encode').classList.toggle('active', name === 'encode');
    document.getElementById('tab-decode').classList.toggle('active', name === 'decode');
    document.getElementById('panel-encode').classList.toggle('active', name === 'encode');
    document.getElementById('panel-decode').classList.toggle('active', name === 'decode');
    window.dispatchEvent(new CustomEvent('qram-tab', { detail: name }));
  }
  // Start on decode tab.
  switchTab('decode');
</script>

</body>
</html>
